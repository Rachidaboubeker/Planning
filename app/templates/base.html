<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Planning Restaurant{% endblock %}</title>

    <!-- CSS personnalisÃ© -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <!-- Font Awesome pour les icÃ´nes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-utensils"></i>
                <span>Planning Restaurant</span>
            </div>

            <div class="nav-menu">
                <a href="{{ url_for('main.index') }}" class="nav-link {{ 'active' if request.endpoint == 'main.index' }}">
                    <i class="fas fa-calendar-week"></i> Planning
                </a>
                <a href="{{ url_for('main.employees') }}" class="nav-link {{ 'active' if request.endpoint == 'main.employees' }}">
                    <i class="fas fa-users"></i> Ã‰quipiers
                </a>
                <a href="#" class="nav-link" onclick="showStats()">
                    <i class="fas fa-chart-bar"></i> Statistiques
                </a>
            </div>
        </div>
    </nav>

    <!-- Contenu principal -->
    <main class="main-content">
        {% block content %}{% endblock %}
    </main>

    <!-- Notifications -->
    <div id="notifications" class="notifications-container"></div>

    <!-- MODAL PRINCIPAL -->
    <div id="globalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Titre du modal</h2>
                <span class="modal-close" onclick="closeModal('globalModal')">&times;</span>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <!-- TEMPLATES -->
    <template id="addEmployeeTemplate">
        <form id="addEmployeeForm" class="form">
            <div class="form-row">
                <div class="form-group">
                    <label for="employeePrenom">PrÃ©nom *</label>
                    <input type="text" id="employeePrenom" name="prenom" required>
                </div>
                <div class="form-group">
                    <label for="employeeNom">Nom *</label>
                    <input type="text" id="employeeNom" name="nom" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="employeePoste">Poste *</label>
                    <select id="employeePoste" name="poste" required>
                        <option value="">SÃ©lectionner un poste</option>
                        {% for type_key, type_info in employee_types.items() %}
                        <option value="{{ type_key }}">{{ type_info.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="employeeTauxHoraire">Taux horaire (â‚¬) *</label>
                    <input type="number" id="employeeTauxHoraire" name="taux_horaire" min="10" max="50" step="0.5" value="15" required>
                </div>
            </div>
        </form>
    </template>

    <template id="addShiftTemplate">
        <form id="addShiftForm" class="form">
            <div class="form-group">
                <label for="shiftEmployee">Ã‰quipier *</label>
                <select id="shiftEmployee" name="employee_id" required>
                    <option value="">SÃ©lectionner un Ã©quipier</option>
                    {% for employee in employees %}
                    <option value="{{ employee.id }}">{{ employee.nom_complet }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="shiftDay">Jour *</label>
                    <select id="shiftDay" name="day" required>
                        {% for day in days %}
                        <option value="{{ day }}">{{ day }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="shiftStartHour">Heure de dÃ©but *</label>
                    <select id="shiftStartHour" name="start_hour" required>
                        {% for hour in hours %}
                        <option value="{{ hour }}">{{ "%02d"|format(hour) }}:00</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="shiftDuration">DurÃ©e (heures) *</label>
                    <select id="shiftDuration" name="duration" required>
                        {% for i in range(1, 13) %}
                        <option value="{{ i }}" {% if i == 4 %}selected{% endif %}>{{ i }}h</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </form>
    </template>

    <!-- ========== NOTIFICATION MANAGER ========== -->
    <script>
    class SimpleNotificationManager {
        static show(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; padding: 15px 20px;
                border-radius: 8px; color: white; font-weight: 500; z-index: 1000;
                transform: translateX(100%); transition: all 0.3s ease;
                ${type === 'success' ? 'background: #28a745;' : ''}
                ${type === 'error' ? 'background: #dc3545;' : ''}
                ${type === 'warning' ? 'background: #ffc107; color: #212529;' : ''}
                ${type === 'info' ? 'background: #17a2b8;' : ''}
            `;

            document.body.appendChild(notification);
            setTimeout(() => notification.style.transform = 'translateX(0)', 100);
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    }
    window.NotificationManager = SimpleNotificationManager;
    </script>

    <!-- ========== MODAL MANAGER ========== -->
    <script>
    class SimpleModalManager {
        constructor() {
            this.modal = document.getElementById('globalModal');
            this.modalTitle = document.getElementById('modalTitle');
            this.modalBody = document.getElementById('modalBody');
            this.modalFooter = document.getElementById('modalFooter');
        }

        showModal(templateId, title, buttons) {
            const template = document.getElementById(templateId);
            if (!template) return;

            this.modalBody.innerHTML = '';
            const content = template.content.cloneNode(true);
            this.modalBody.appendChild(content);

            this.modalTitle.textContent = title;
            this.modalFooter.innerHTML = buttons.map(btn =>
                `<button type="button" class="btn ${btn.class}" onclick="${btn.onclick}">${btn.text}</button>`
            ).join('');
            this.modal.style.display = 'block';
        }

        close() { this.modal.style.display = 'none'; }
    }

    const modalManager = new SimpleModalManager();

    function showAddEmployeeModal() {
        modalManager.showModal('addEmployeeTemplate', 'ðŸ‘¤ Nouvel Ã©quipier', [
            { text: 'Annuler', class: 'btn-secondary', onclick: 'modalManager.close()' },
            { text: 'CrÃ©er', class: 'btn-primary', onclick: 'handleAddEmployee()' }
        ]);
    }

    function showAddShiftModal(day, hour) {
        modalManager.showModal('addShiftTemplate', 'ðŸ“… Nouveau crÃ©neau', [
            { text: 'Annuler', class: 'btn-secondary', onclick: 'modalManager.close()' },
            { text: 'Ajouter', class: 'btn-primary', onclick: 'handleAddShift()' }
        ]);
        if (day) document.getElementById('shiftDay').value = day;
        if (hour) document.getElementById('shiftStartHour').value = hour;
    }

    function closeModal() { modalManager.close(); }

    window.onclick = function(event) {
        if (event.target === document.getElementById('globalModal')) {
            modalManager.close();
        }
    };
    </script>

    <!-- ========== GESTIONNAIRES DE FORMULAIRES ========== -->
    <script>
    async function handleAddEmployee() {
        const form = document.getElementById('addEmployeeForm');
        if (!form?.checkValidity()) {
            form?.reportValidity();
            return;
        }

        const formData = new FormData(form);
        const employeeData = Object.fromEntries(formData.entries());
        employeeData.taux_horaire = parseFloat(employeeData.taux_horaire);

        try {
            const response = await fetch('/api/employees', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(employeeData)
            });

            const result = await response.json();
            if (result.success) {
                modalManager.close();
                NotificationManager.show('âœ… EmployÃ© crÃ©Ã©', 'success');
                location.reload();
            } else {
                NotificationManager.show('âŒ ' + result.error, 'error');
            }
        } catch (error) {
            NotificationManager.show('âŒ Erreur de connexion', 'error');
        }
    }

    async function handleAddShift() {
        const form = document.getElementById('addShiftForm');
        if (!form?.checkValidity()) {
            form?.reportValidity();
            return;
        }

        const formData = new FormData(form);
        const shiftData = Object.fromEntries(formData.entries());
        shiftData.start_hour = parseInt(shiftData.start_hour);
        shiftData.duration = parseInt(shiftData.duration);

        try {
            const response = await fetch('/api/shifts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(shiftData)
            });

            const result = await response.json();
            if (result.success) {
                modalManager.close();
                NotificationManager.show('âœ… CrÃ©neau ajoutÃ©', 'success');
                location.reload();
            } else {
                NotificationManager.show('âŒ ' + result.error, 'error');
            }
        } catch (error) {
            NotificationManager.show('âŒ Erreur de connexion', 'error');
        }
    }

    function generateRandomAvatars() {
        const colors = ['74b9ff', '00b894', 'fdcb6e', 'a29bfe', 'fd79a8', '6c5ce7'];
        document.querySelectorAll('img[src*="ui-avatars.com"]').forEach(img => {
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            img.src = img.src.replace(/background=[^&]*/, `background=${randomColor}&t=${Date.now()}`);
        });
        NotificationManager.show('ðŸŽ¨ Nouveaux avatars gÃ©nÃ©rÃ©s', 'success');
    }

    function showStats() {
        NotificationManager.show('ðŸ“Š Statistiques en cours de dÃ©veloppement', 'info');
    }
    </script>

    <!-- ========== CSS MINIMAL ========== -->
    <style>
    .modal {
        display: none; position: fixed; z-index: 1000; left: 0; top: 0;
        width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
        background: white; margin: 5% auto; padding: 0; border-radius: 12px;
        width: 90%; max-width: 600px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    .modal-header {
        background: linear-gradient(135deg, #667eea, #764ba2); color: white;
        padding: 1.5rem 2rem; border-radius: 12px 12px 0 0;
        display: flex; justify-content: space-between; align-items: center;
    }
    .modal-close { font-size: 2rem; cursor: pointer; opacity: 0.8; }
    .modal-close:hover { opacity: 1; }
    .modal-body { padding: 2rem; }
    .modal-footer {
        padding: 1.5rem 2rem; background: #f8f9fa; border-radius: 0 0 12px 12px;
        display: flex; justify-content: flex-end; gap: 1rem;
    }
    .form { display: flex; flex-direction: column; gap: 1.5rem; }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
    .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .form-group label { font-weight: 500; color: #374151; }
    .form-group input, .form-group select {
        padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;
    }
    .form-group input:focus, .form-group select:focus {
        outline: none; border-color: #667eea;
    }
    .btn {
        padding: 0.75rem 1.5rem; border: none; border-radius: 8px;
        font-weight: 500; cursor: pointer; transition: all 0.3s ease;
    }
    .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2); color: white;
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-secondary:hover { background: #5a6268; }
    </style>

    {% block extra_js %}{% endblock %}
</body>
</html>