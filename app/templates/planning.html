{% extends "base.html" %}

{% block title %}Planning Semaine - Restaurant{% endblock %}

{% block extra_css %}
<style>
    /* Styles sp√©cifiques pour la page planning */
    .planning-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .granularity-selector-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(255, 255, 255, 0.9);
        padding: 0.5rem 1rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        border: 1px solid #e1e5e9;
        backdrop-filter: blur(10px);
    }

    .granularity-selector-container label {
        font-weight: 500;
        color: #4a5568;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .granularity-select {
        padding: 0.375rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        background: white;
        font-size: 0.875rem;
        cursor: pointer;
        transition: var(--transition);
        min-width: 120px;
    }

    .granularity-select:hover {
        border-color: #6366f1;
    }

    .granularity-select:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .granularity-info {
        font-size: 0.75rem;
        color: #6b7280;
        background: #f9fafb;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        border: 1px solid #e5e7eb;
    }

    .granularity-info small {
        display: block;
        font-weight: 500;
    }

    #slotsCount {
        font-weight: 600;
        color: #4f46e5;
    }

    /* Section des colonnes d'employ√©s restaur√©e */
    .employees-section {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: var(--border-radius-xl);
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-xl);
    }

    .employees-title {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 1.5rem;
        color: #333;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .employees-title i {
        color: #667eea;
    }

    /* Statistiques rapides */
    .quick-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 2rem;
    }

    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: var(--border-radius-lg);
        border: 1px solid #dee2e6;
        text-align: center;
        transition: var(--transition);
        box-shadow: var(--shadow);
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        font-size: 0.9rem;
        color: #6c757d;
        font-weight: 500;
    }

    /* Actions rapides */
    .quick-actions {
        display: flex;
        gap: 0.5rem;
        margin-left: auto;
    }

    .btn-icon-only {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: var(--shadow);
    }

    .btn-photo {
        background: linear-gradient(135deg, #17a2b8, #138496);
        color: white;
    }

    .btn-photo:hover {
        background: linear-gradient(135deg, #138496, #117a8b);
        transform: scale(1.1);
        box-shadow: var(--shadow-lg);
    }

    /* Indicateur de granularit√© */
    .granularity-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(111, 66, 193, 0.9);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        z-index: 1000;
        backdrop-filter: blur(10px);
        box-shadow: var(--shadow-lg);
    }

    /* Navigation de semaine am√©lior√©e */
    .week-navigation {
        display: flex;
        align-items: center;
        gap: 2rem;
        background: rgba(255, 255, 255, 0.1);
        padding: 1rem 2rem;
        border-radius: var(--border-radius-lg);
        backdrop-filter: blur(10px);
    }

    .current-week {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.8rem;
        font-weight: 300;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .btn-outline {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(10px);
    }

    .btn-outline:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.5);
        transform: translateY(-2px);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .planning-actions {
            flex-direction: column;
            align-items: stretch;
        }

        .quick-actions {
            margin-left: 0;
            justify-content: center;
        }

        .granularity-selector-container {
            flex-direction: column;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
        }

        .granularity-indicator {
            bottom: 10px;
            right: 10px;
            font-size: 0.7rem;
            padding: 0.4rem 0.8rem;
        }

        .employees-section {
            padding: 1.5rem;
        }

        .employees-title {
            font-size: 1.3rem;
        }

        .quick-stats {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }

        .week-navigation {
            flex-direction: column;
            gap: 1rem;
            padding: 1rem;
        }

        .current-week {
            font-size: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- CONFIGURATION FLASK POUR JAVASCRIPT -->
<script>
// Configuration Flask transmise √† JavaScript
window.FLASK_CONFIG = {
    HOURS_RANGE: {{ config_data.HOURS_RANGE | tojson }},
    DAYS_OF_WEEK: {{ config_data.DAYS_OF_WEEK | tojson }},
    EMPLOYEE_TYPES: {{ config_data.EMPLOYEE_TYPES | tojson }},
    TIME_SLOT_GRANULARITY: {{ config_data.TIME_SLOT_GRANULARITY | tojson }},
    AVAILABLE_GRANULARITIES: {{ config_data.AVAILABLE_GRANULARITIES | tojson }},
    ALL_TIME_SLOTS: {{ config_data.ALL_TIME_SLOTS | tojson }},
    GRANULARITY_INFO: {{ config_data.GRANULARITY_INFO | tojson }}
};

window.FLASK_DATA = {
    employees: {{ employees | tojson }},
    shifts: {{ shifts | tojson }},
    stats: {{ stats | tojson }}
};

console.log('üìä Configuration Flask charg√©e');
</script>

<div class="planning-container">
    <div class="planning-header">
        <div class="week-navigation">
            <button class="btn btn-outline" onclick="previousWeek()">
                <i class="fas fa-chevron-left"></i> Semaine pr√©c√©dente
            </button>
            <h1 class="current-week">
                <i class="fas fa-calendar-week"></i>
                <span id="weekTitle">Semaine du 9 au 15 Juin 2025</span>
            </h1>
            <button class="btn btn-outline" onclick="nextWeek()">
                Semaine suivante <i class="fas fa-chevron-right"></i>
            </button>
        </div>

        <div class="planning-actions">
            <button class="btn btn-primary" onclick="showAddShiftModal()">
                <i class="fas fa-plus"></i> Ajouter un cr√©neau
            </button>
            <button class="btn btn-secondary" onclick="showAddEmployeeModal()">
                <i class="fas fa-user-plus"></i> Nouvel √©quipier
            </button>

            <div class="granularity-selector-container">
                <label for="granularitySelect">
                    <i class="fas fa-clock"></i> Granularit√© :
                </label>
                <select id="granularitySelect" class="granularity-select">
                    {% for value, label in available_granularities.items() %}
                    <option value="{{ value }}" {% if value == time_slot_granularity %}selected{% endif %}>
                        {{ label }}
                    </option>
                    {% endfor %}
                </select>
                <div class="granularity-info">
                    <small>Cr√©neaux: <span id="slotsCount">{{ config_data.GRANULARITY_INFO.total_slots }}</span></small>
                </div>
            </div>

            <div class="quick-actions">
                <button class="btn-icon-only btn-photo" onclick="showBulkPhotoModal()" title="G√©rer les photos">
                    <i class="fas fa-camera"></i>
                </button>
                <button class="btn-icon-only btn-photo" onclick="generateRandomAvatars()" title="Avatars al√©atoires">
                    <i class="fas fa-dice"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- SECTION DES COLONNES D'EMPLOY√âS RESTAUR√âE -->
    <div class="employees-section">
        <h2 class="employees-title">
            <i class="fas fa-users"></i>
            Colonnes d'employ√©s
        </h2>
        <div class="employee-columns" id="employeeColumns">
            {% for employee in employees %}
            <div class="employee-column {{ employee.poste }}" data-employee-id="{{ employee.id }}">
                <img class="employee-avatar"
                     src="https://ui-avatars.com/api/?name={{ employee.prenom }}+{{ employee.nom }}&size=45&background={{ employee.type_info.color.replace('#', '') }}&color=fff"
                     alt="{{ employee.nom_complet }}"
                     onerror="this.src='https://ui-avatars.com/api/?name={{ employee.prenom.0 }}{{ employee.nom.0 }}&size=45&background=6c757d&color=fff'">
                <div class="employee-info">
                    <div class="employee-name">{{ employee.nom_complet }}</div>
                    <div class="employee-role">{{ employee.type_info.name }}</div>
                </div>
            </div>
            {% endfor %}

            <!-- Colonne libre -->
            <div class="employee-column libre">
                <div class="employee-info">
                    <div class="employee-name">Colonne libre</div>
                    <div class="employee-role">Disponible pour assignation</div>
                </div>
            </div>
        </div>
    </div>

    <div class="legend-container" id="legendContainer"></div>

    <div class="planning-wrapper">
        <div class="planning-grid-container">
            <div class="planning-grid-header">
                <div class="time-column-header">
                    <i class="fas fa-clock"></i> Heure
                </div>
                {% for day in days %}
                <div class="day-header">{{ day }}</div>
                {% endfor %}
            </div>
            <div class="planning-grid" id="planningGrid"></div>
        </div>
    </div>

    <div class="quick-stats">
        <div class="stat-card">
            <div class="stat-value" id="totalHoursDisplay">{{ stats.total_hours }}</div>
            <div class="stat-label">Heures totales</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="activeEmployeesDisplay">{{ stats.active_employees }}</div>
            <div class="stat-label">√âquipiers actifs</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="averageHoursDisplay">{{ "%.1f"|format(stats.average_hours) }}h</div>
            <div class="stat-label">Moyenne par personne</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="photoCountDisplay">
                <span id="photoCount">0</span>
            </div>
            <div class="stat-label">Photos ajout√©es</div>
        </div>
    </div>
</div>

<div class="granularity-indicator" id="granularityIndicator">
    <i class="fas fa-clock"></i>
    <span id="granularityIndicatorText">{{ config_data.GRANULARITY_INFO.granularity_label }}</span>
</div>

<!-- JAVASCRIPT SP√âCIFIQUE √Ä LA PAGE PLANNING -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentWeekOffset = 0;
    let employees = new Map();
    let shifts = new Map();

    // Charger les donn√©es Flask dans les variables globales
    if (window.FLASK_DATA?.employees) {
        window.FLASK_DATA.employees.forEach(emp => {
            // Ajouter nom_complet s'il n'existe pas
            if (!emp.nom_complet) {
                emp.nom_complet = `${emp.prenom} ${emp.nom}`;
            }
            employees.set(emp.id, emp);
        });
        window.employees = employees; // Exposer globalement

        // Cr√©er un AppState global pour compatibilit√©
        if (!window.AppState) {
            window.AppState = {
                employees: employees,
                shifts: new Map()
            };
        }
    }

    if (window.FLASK_DATA?.shifts) {
        window.FLASK_DATA.shifts.forEach(shift => shifts.set(shift.id, shift));
        window.shifts = shifts; // Exposer globalement
        window.AppState.shifts = shifts;
    }

    // Initialiser le gestionnaire d'avatars
    try {
        if (!window.avatarManager && typeof AvatarManager !== 'undefined') {
            window.avatarManager = new AvatarManager();
            console.log('‚úÖ Gestionnaire d\'avatars initialis√©');

            // Mettre √† jour le compteur de photos
            updatePhotoCount();
        }
    } catch (error) {
        console.error('‚ùå Erreur initialisation avatars:', error);
    }

    // Fonctions de navigation par semaine
    window.previousWeek = function() {
        currentWeekOffset--;
        updateWeekDisplay();
        showNotification('üìÖ Semaine pr√©c√©dente', 'success');
    };

    window.nextWeek = function() {
        currentWeekOffset++;
        updateWeekDisplay();
        showNotification('üìÖ Semaine suivante', 'success');
    };

    function updateWeekDisplay() {
        const today = new Date();
        const monday = new Date(today);
        monday.setDate(today.getDate() - today.getDay() + 1 + (currentWeekOffset * 7));
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);

        const options = { day: 'numeric', month: 'long' };
        const mondayStr = monday.toLocaleDateString('fr-FR', options);
        const sundayStr = sunday.toLocaleDateString('fr-FR', options);

        document.getElementById('weekTitle').textContent = `Semaine du ${mondayStr} au ${sundayStr}`;
    }

    // Gestionnaire de granularit√©
    const granularitySelect = document.getElementById('granularitySelect');
    if (granularitySelect) {
        granularitySelect.addEventListener('change', function() {
            const newGranularity = parseInt(this.value);
            console.log(`Changement de granularit√©: ${newGranularity} minutes`);

            // Mettre √† jour l'indicateur
            const indicator = document.getElementById('granularityIndicatorText');
            if (indicator) {
                const labels = {
                    15: '15 min',
                    30: '30 min',
                    60: '1 heure'
                };
                indicator.textContent = labels[newGranularity] || `${newGranularity} min`;
            }

            // Mettre √† jour le compteur de cr√©neaux
            const slotsCount = document.getElementById('slotsCount');
            if (slotsCount) {
                const totalSlots = (16 * 60) / newGranularity; // 16 heures de service
                slotsCount.textContent = totalSlots;
            }

            showNotification(`‚è±Ô∏è Granularit√© chang√©e: ${newGranularity} minutes`, 'success');

            // Reg√©n√©rer le planning si le renderer est disponible
            if (typeof PlanningRenderer !== 'undefined' && PlanningRenderer.generatePlanningGrid) {
                setTimeout(() => PlanningRenderer.generatePlanningGrid(), 100);
            }
        });
    }

    // Fonction pour mettre √† jour le compteur de photos
    function updatePhotoCount() {
        const photoCountElement = document.getElementById('photoCount');
        if (photoCountElement && window.avatarManager) {
            const count = window.avatarManager.photoCache ? window.avatarManager.photoCache.size : 0;
            photoCountElement.textContent = count;
        }
    }

    // Fonction globale pour g√©n√©rer des avatars al√©atoires
    window.generateRandomAvatars = function() {
        if (window.avatarManager && typeof window.avatarManager.generateRandomAvatars === 'function') {
            window.avatarManager.generateRandomAvatars();
        } else {
            // Fallback: simuler la g√©n√©ration d'avatars
            showNotification('üé® Nouveaux avatars g√©n√©r√©s al√©atoirement', 'success');

            // Mettre √† jour visuellement les avatars dans les colonnes
            const avatarImages = document.querySelectorAll('.employee-avatar');
            avatarImages.forEach(img => {
                const timestamp = Date.now();
                const currentSrc = img.src;
                if (currentSrc.includes('ui-avatars.com')) {
                    img.src = currentSrc + '&t=' + timestamp;
                }
            });
        }
        updatePhotoCount();
    };

    // Am√©liorer l'affichage des colonnes d'employ√©s
    function enhanceEmployeeColumns() {
        const columns = document.querySelectorAll('.employee-column');
        columns.forEach(column => {
            // Ajouter des effets hover am√©lior√©s
            column.addEventListener('mouseenter', function() {
                this.style.transform = 'translateX(5px) translateY(-2px)';
            });

            column.addEventListener('mouseleave', function() {
                this.style.transform = 'translateX(0) translateY(0)';
            });

            // Clic pour modifier l'employ√©
            column.addEventListener('click', function() {
                const employeeId = this.dataset.employeeId;
                if (employeeId) {
                    showEditEmployeeModal(employeeId);
                }
            });
        });
    }

    // Attendre que tous les scripts soient charg√©s avant d'initialiser
    setTimeout(() => {
        console.log('üéØ Initialisation sp√©cifique √† la page planning...');

        // Am√©liorer les colonnes d'employ√©s
        enhanceEmployeeColumns();

        // Initialiser la l√©gende si les scripts sont pr√™ts
        if (typeof PlanningUI !== 'undefined' && PlanningUI.updateLegend) {
            PlanningUI.updateLegend();
        }

        // Initialiser l'affichage si les scripts sont pr√™ts
        if (typeof PlanningRenderer !== 'undefined' && PlanningRenderer.generatePlanningGrid) {
            PlanningRenderer.generatePlanningGrid();
        }

        // Mettre √† jour l'affichage initial de la semaine
        updateWeekDisplay();

        // Mettre √† jour le compteur de photos
        updatePhotoCount();

        console.log('‚úÖ Page planning initialis√©e avec colonnes d\'employ√©s restaur√©es');
    }, 1500);

    // Fonction pour afficher les statistiques
    window.showStats = function() {
        if (window.AppState && window.AppState.employees) {
            const totalEmployees = window.AppState.employees.size;
            const totalShifts = window.AppState.shifts ? window.AppState.shifts.size : 0;

            showNotification(`üìä ${totalEmployees} employ√©s, ${totalShifts} cr√©neaux`, 'info');
        } else {
            showNotification('üìä Statistiques : En cours de chargement...', 'info');
        }
    };
});
</script>

{% endblock %}